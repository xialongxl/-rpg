<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻想RPG与抽卡联动游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: #0f1c3f url('https://img.freepik.com/free-vector/dark-blue-blurred-background_1034-589.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 30px;
            text-shadow: 0 0 15px rgba(0, 195, 255, 1), 0 0 30px rgba(0, 195, 255, 0.8);
            background: linear-gradient(to right, #ffd700, #ff4500, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 1.5s ease-in-out infinite alternate, pulse-text 3s ease-in-out infinite;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(0, 195, 255, 0.7), 0 0 20px rgba(0, 195, 255, 0.5); }
            to { text-shadow: 0 0 20px rgba(0, 195, 255, 1), 0 0 40px rgba(0, 195, 255, 0.8); }
        }
        
        @keyframes pulse-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .wish-button {
            background: linear-gradient(135deg, #00c4ff 0%, #1e3c72 100%);
            border: none;
            color: #fff;
            padding: 18px 40px;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 195, 255, 0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }
        
        .wish-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 195, 255, 0.7);
            background: linear-gradient(135deg, #ff00cc 0%, #3333ff 100%);
        }
        
        .wish-button-10 {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .wish-button-heal {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        }
        
        .wish-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.6s;
        }
        
        .wish-button:hover::before {
            left: 100%;
        }
        
        .wish-results {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
            min-height: 300px;
        }
        
        .wish-item {
            width: 180px;
            height: 260px;
            perspective: 1200px;
            animation: float 3s ease-in-out infinite;
            position: relative;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .wish-item:nth-child(2) { animation-delay: 0.3s; }
        .wish-item:nth-child(3) { animation-delay: 0.6s; }
        .wish-item:nth-child(4) { animation-delay: 0.9s; }
        .wish-item:nth-child(5) { animation-delay: 1.2s; }
        
        .wish-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s ease-in-out;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
        }
        
        .wish-card.flipped {
            transform: rotateY(180deg);
        }
        
        .wish-card-front, .wish-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: 15px;
            justify-content: center;
            overflow: hidden;
        }
        
        .wish-card-back {
            transform: rotateY(180deg);
            justify-content: flex-start;
        }
        
        .rarity-1 {
            background: #f5f5f5;
            border: 3px solid #cccccc;
            color: #333333;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .rarity-2 {
            background: #4caf50;
            border: 3px solid #388e3c;
            color: #ffffff;
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .rarity-3 {
            background: #2196f3;
            border: 3px solid #1976d2;
            color: #ffffff;
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.4);
        }
        .rarity-4 {
            background: #9c27b0;
            border: 3px solid #7b1fa2;
            color: #ffffff;
            box-shadow: inset 0 0 25px rgba(255, 255, 255, 0.5);
        }
        .rarity-5 {
            background: #ff9800;
            border: 3px solid #f57c00;
            color: #ffffff;
            box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.6);
        }
        .rarity-6 {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            border: 3px solid #d4a017;
            color: #ffffff;
            animation: shine 2s infinite;
        }
        .rarity-7 {
            background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%);
            border: 3px solid #a1122a;
            color: #ffffff;
            animation: shine 1.5s infinite;
        }
        
        @keyframes shine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .rarity-6::before, .rarity-7::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            animation: glow-rotate 5s linear infinite;
            pointer-events: none;
        }
        
        @keyframes glow-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .item-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.7));
            transition: transform 0.3s;
        }
        
        .item-image:hover {
            transform: scale(1.1);
        }
        
        .wish-card-front.rarity-1 .item-image { filter: hue-rotate(0deg) brightness(1.2) drop-shadow(0 0 15px rgba(255, 255, 255, 0.7)); }
        .wish-card-front.rarity-2 .item-image { filter: hue-rotate(120deg) saturate(1.5) drop-shadow(0 0 15px rgba(0, 100, 0, 0.6)); }
        .wish-card-front.rarity-3 .item-image { filter: hue-rotate(210deg) saturate(1.5) drop-shadow(0 0 15px rgba(0, 0, 139, 0.6)); }
        .wish-card-front.rarity-4 .item-image { filter: hue-rotate(280deg) saturate(1.5) drop-shadow(0 0 15px rgba(75, 0, 130, 0.6)); }
        .wish-card-front.rarity-5 .item-image { filter: hue-rotate(30deg) saturate(1.5) drop-shadow(0 0 15px rgba(139, 69, 19, 0.6)); }
        .wish-card-front.rarity-6 .item-image { filter: hue-rotate(50deg) saturate(1.5) drop-shadow(0 0 15px rgba(184, 134, 11, 0.6)); }
        .wish-card-front.rarity-7 .item-image { filter: hue-rotate(0deg) saturate(2) drop-shadow(0 0 15px rgba(139, 0, 0, 0.6)); }
        
        .item-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
        }
        
        .rarity-stars {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .star {
            font-size: 1.3rem;
            margin: 0 3px;
            animation: star-twinkle 1.5s infinite;
        }
        
        @keyframes star-twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .wish-card .rarity-1 .star { 
            color: #f5f5f5; 
            text-shadow: 0 0 6px rgba(0, 0, 0, 0.6); 
        }
        .wish-card .rarity-2 .star { 
            color: #4caf50; 
            text-shadow: 0 0 6px rgba(0, 100, 0, 0.6); 
        }
        .wish-card .rarity-3 .star { 
            color: #2196f3; 
            text-shadow: 0 0 6px rgba(0, 0, 139, 0.6); 
        }
        .wish-card .rarity-4 .star { 
            color: #9c27b0; 
            text-shadow: 0 0 6px rgba(75, 0, 130, 0.6); 
        }
        .wish-card .rarity-5 .star { 
            color: #ff9800; 
            text-shadow: 0 0 6px rgba(139, 69, 19, 0.6); 
        }
        .wish-card .rarity-6 .star { 
            color: #ffd700; 
            text-shadow: 0 0 6px rgba(184, 134, 11, 0.6); 
        }
        .wish-card .rarity-7 .star { 
            color: #ff0000; 
            text-shadow: 0 0 6px rgba(139, 0, 0, 0.6); 
        }
        
        .item-description {
            font-size: 0.85rem;
            line-height: 1.5;
            margin-top: 15px;
            text-align: left;
            width: 100%;
            overflow-y: auto;
            max-height: 110px;
            padding-right: 8px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .stats-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 195, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .pity-counter {
            margin-bottom: 20px;
        }
        
        .pity-bar {
            height: 12px;
            background: #222;
            border-radius: 6px;
            margin-top: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .pity-progress {
            height: 100%;
            background: linear-gradient(90deg, #00c4ff, #ff00cc);
            width: 0%;
            transition: width 0.4s ease;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .rarity-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            font-size: 1rem;
            margin: 8px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .wish-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease;
        }
        
        .wish-effect.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .effect-content {
            width: 300px;
            height: 300px;
            object-fit: contain;
            background-color: transparent;
            border-radius: 25px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.9);
            animation: pulse 1.2s infinite alternate;
            opacity: 1;
        }
        
        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.7); }
            to { transform: scale(1.08); box-shadow: 0 0 60px rgba(255, 215, 0, 1); }
        }
        
        .particle-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: particle-move 10s linear infinite;
        }
        
        @keyframes particle-move {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0.5; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }
        
        @media (max-width: 600px) {
            .wish-item {
                width: 150px;
                height: 220px;
            }
            .item-image {
                width: 80px;
                height: 80px;
            }
            .button-group {
                flex-direction: column;
            }
            .action-buttons {
                flex-direction: column;
            }
            h1 {
                font-size: 2.2rem;
            }
            .effect-content {
                width: 200px;
                height: 200px;
            }
        }

        /* RPG游戏相关样式 */
        .game-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 195, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .status {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .log {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* 背包样式 */
        .inventory-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 195, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .inventory-header {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .inventory-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .inventory-item.glow {
            animation: slot-glow 0.5s ease-in-out;
        }

        .inventory-item-info {
            flex: 1;
        }

        .inventory-item-actions {
            display: flex;
            gap: 10px;
        }

        /* 装备栏样式 */
        .equipment-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 195, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .equipment-header {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .equipment-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .equipment-slot-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .equipment-slot-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .equipment-slot.glow {
            animation: slot-glow 0.5s ease-in-out;
        }

        /* 强化系统样式 */
        .enhance-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 195, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .enhance-header {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .enhance-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .enhance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .enhance-item-info {
            flex: 1;
        }

        .enhance-item-actions {
            display: flex;
            gap: 10px;
        }

        @keyframes slot-glow {
            0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 1); }
            100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        }

        .action-button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .equip-main-hand-button {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        }

        .equip-off-hand-button {
            background: linear-gradient(135deg, #00c4ff 0%, #1e3c72 100%);
        }

        .equip-accessory-button {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
        }

        .sell-button {
            background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%);
        }

        .unequip-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }

        .enhance-button {
            background: linear-gradient(135deg, #ffeb3b 0%, #f57c00 100%);
        }

        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }

        .blink {
            animation: blink 0.5s ease-in-out 2;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="particle-bg" id="particle-bg"></div>
    <div class="container">
        <h1>幻想RPG与抽卡联动游戏</h1>
        
        <!-- RPG游戏面板 -->
        <div class="game-panel">
            <div class="status">
                <div>玩家等级: <span id="player-level">1</span></div>
                <div>经验值: <span id="player-exp">0</span>/<span id="exp-to-level">50</span></div>
                <div>生命值: <span id="player-hp">100</span>/<span id="player-max-hp">100</span></div>
            </div>
            <div class="status">
                <div>攻击力: <span id="player-attack">10</span></div>
                <div>防御力: <span id="player-defense">0</span></div>
                <div>金币: <span id="player-gold">0</span></div>
            </div>
            <div class="status">
                <div>怪物生命值: <span id="monster-hp">0</span></div>
                <div>攻击力: <span id="monster-attack">0</span></div>
                <div>第 <span id="battle-count">0</span> 次战斗</div>
            </div>
            <div class="log" id="battle-log"></div>
            <div class="action-buttons">
                <button class="wish-button" id="fight-button">战斗</button>
                <button class="wish-button wish-button-10" id="gacha-button">抽卡 (100金币)</button>
                <button class="wish-button wish-button-heal" id="heal-button">回血 (10金币)</button>
            </div>
        </div>

        <!-- 装备栏 -->
        <div class="equipment-panel">
            <div class="equipment-header">装备栏</div>
            <div class="equipment-slot" id="main-hand-slot">
                <div class="equipment-slot-info">主手: 无装备</div>
            </div>
            <div class="equipment-slot" id="off-hand-slot">
                <div class="equipment-slot-info">副手: 无装备</div>
            </div>
            <div class="equipment-slot" id="accessory-slot">
                <div class="equipment-slot-info">饰品: 无装备</div>
            </div>
        </div>

        <!-- 背包面板 -->
        <div class="inventory-panel">
            <div class="inventory-header">背包（<span id="inventory-count">0</span>/10）</div>
            <div class="inventory-list" id="inventory-list"></div>
        </div>

        <!-- 强化系统面板 -->
        <div class="enhance-panel">
            <div class="enhance-header">强化系统</div>
            <div class="enhance-list" id="enhance-list"></div>
        </div>

        <!-- 抽卡模拟器统计面板 -->
        <div class="stats-panel">
            <div class="pity-counter">
                <div>7星保底计数: <span id="pity-count">0</span>/90</div>
                <div class="pity-bar"><div class="pity-progress" id="pity-progress"></div></div>
            </div>
            <div class="rarity-stats">
                <div class="stat-item">7星: <span id="count-7">0</span></div>
                <div class="stat-item">6星: <span id="count-6">0</span></div>
                <div class="stat-item">5星: <span id="count-5">0</span></div>
                <div class="stat-item">4星: <span id="count-4">0</span></div>
                <div class="stat-item">3星: <span id="count-3">0</span></div>
                <div class="stat-item">2星: <span id="count-2">0</span></div>
                <div class="stat-item">1星: <span id="count-1">0</span></div>
                <div class="stat-item">总计: <span id="wish-count">0</span></div>
            </div>
        </div>
        
        <div class="button-group">
            <button class="wish-button" id="wish-button" style="display: none;">抽取武器 (1次)</button>
            <button class="wish-button wish-button-10" id="wish-button-10" style="display: none;">抽取武器 (10次)</button>
        </div>
        
        <div class="wish-results" id="wish-results"></div>
    </div>
    
    <div class="wish-effect" id="wish-effect">
        <img class="effect-content" src="https://static.wikia.nocookie.net/to-aru-majutsu-no-index/images/1/12/Pentagram-GreatGold.png" alt="Wish Effect">
    </div>

    <script src="enhanceSystem.js"></script>
    <script>
        // 抽卡模拟器代码
        const weaponTypes = {
            "单手剑": ["之刃", "短剑", "魔剑", "光刃", "邪刃", "圣剑", "灵剑"],
            "双手剑": ["巨剑", "重剑", "斩龙剑", "破军剑", "霸者剑"],
            "法杖": ["法杖", "之杖", "魔杖", "权杖"],
            "弓": ["神弓", "长弓", "魔弓", "灵弓", "穿云弓"],
            "魔法书": ["魔导书", "圣典", "咒文书", "法典", "魔典"],
            "匕首": ["短刃", "暗刃", "影刺", "毒牙", "迅捷刃"],
            "盾牌": ["坚盾", "圣盾", "龙盾", "守护者", "壁垒"]
        };

        const weaponPrefixes = ["闪耀", "暗影", "烈焰", "寒冰", "雷霆", "圣光", "幽冥", 
                              "虚空", "混沌", "神圣", "龙息", "凤凰", "泰坦", "天使", "恶魔"];
        
        const weaponDescriptions = [
            "这把武器由远古巨龙的精血淬炼而成，", 
            "传说锻造时加入了星辰碎片，", 
            "曾被多位传奇英雄使用过，", 
            "表面刻有失传的古代符文，", 
            "在特定月相下会觉醒真正力量，",
            "锻造时封印了强大恶魔的灵魂，",
            "能吸收周围环境的元素能量，",
            "历代主人都成为了传奇，",
            "来自已经消失的精灵王国，"
        ];
        
        const weaponEffects = [
            "但使用它会逐渐侵蚀使用者的神志。",
            "它的完整历史至今仍是个谜。",
            "据说能斩断时空的裂隙。",
            "在正义之人手中会发出圣洁光芒。",
            "会记录所有持有者的战斗记忆。",
            "能免疫九阶以下的魔法攻击。",
            "使用时会产生龙吟般的共鸣。"
        ];

        const weaponImages = {
            "单手剑": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/broadsword.png",
            "双手剑": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/relic-blade.png",
            "法杖": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/wizard-staff.png",
            "弓": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/pocket-bow.png",
            "魔法书": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/spell-book.png",
            "匕首": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/bowie-knife.png",
            "盾牌": "https://raw.githubusercontent.com/xialongxl/imgbox/refs/heads/main/templar-shield.png"
        };

        let pityCounter = 0;
        const stats = { 7: 0, 6: 0, 5: 0, 4: 0, 3: 0, 2: 0, 1: 0, total: 0 };
        const wishEffect = document.getElementById('wish-effect');
        
        const elements = {
            pityCount: document.getElementById('pity-count'),
            pityProgress: document.getElementById('pity-progress'),
            wishCount: document.getElementById('wish-count'),
            count7: document.getElementById('count-7'),
            count6: document.getElementById('count-6'),
            count5: document.getElementById('count-5'),
            count4: document.getElementById('count-4'),
            count3: document.getElementById('count-3'),
            count2: document.getElementById('count-2'),
            count1: document.getElementById('count-1'),
            results: document.getElementById('wish-results'),
            btnSingle: document.getElementById('wish-button'),
            btnMulti: document.getElementById('wish-button-10')
        };

        function updateStats() {
            elements.pityCount.textContent = pityCounter;
            elements.pityProgress.style.width = `${(pityCounter / 90) * 100}%`;
            elements.wishCount.textContent = stats.total;
            elements.count7.textContent = stats[7];
            elements.count6.textContent = stats[6];
            elements.count5.textContent = stats[5];
            elements.count4.textContent = stats[4];
            elements.count3.textContent = stats[3];
            elements.count2.textContent = stats[2];
            elements.count1.textContent = stats[1];
        }

        function generateWeapon() {
            let rarity;
            const rand = Math.random();
            
            if (pityCounter >= 89) {
                rarity = 7;
                pityCounter = 0;
            } else if (pityCounter >= 75 && rand < 0.002 + (pityCounter - 74) * 0.02) {
                rarity = 7;
                pityCounter = 0;
            } else if (rand < 0.002) {
                rarity = 7;
                pityCounter = 0;
            } else if (rand < 0.008) {
                rarity = 6;
                pityCounter++;
            } else if (rand < 0.028) {
                rarity = 5;
                pityCounter++;
            } else if (rand < 0.088) {
                rarity = 4;
                pityCounter++;
            } else if (rand < 0.208) {
                rarity = 3;
                pityCounter++;
            } else if (rand < 0.408) {
                rarity = 2;
                pityCounter++;
            } else {
                rarity = 1;
                pityCounter++;
            }
            
            stats[rarity]++;
            stats.total++;
            return createWeapon(rarity);
        }

        function createWeapon(rarity) {
            const types = Object.keys(weaponTypes);
            const type = types[Math.floor(Math.random() * types.length)];
            const suffixes = weaponTypes[type];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            const name = weaponPrefixes[Math.floor(Math.random() * weaponPrefixes.length)] + suffix;
            
            let desc = "";
            const descParts = rarity >= 6 ? 4 : rarity >= 4 ? 3 : 2;
            const usedIndices = new Set();
            
            for (let i = 0; i < descParts; i++) {
                let idx;
                do { idx = Math.floor(Math.random() * weaponDescriptions.length); } 
                while (usedIndices.has(idx));
                
                usedIndices.add(idx);
                desc += weaponDescriptions[idx];
            }
            
            desc += weaponEffects[Math.floor(Math.random() * weaponEffects.length)];
            
            return {
                name: name,
                type: type,
                rarity: rarity,
                description: desc,
                enhanceLevel: 0,
                maxEnhanceLevel: 10
            };
        }

        function displayWeapon(weapon) {
            const item = document.createElement('div');
            item.className = 'wish-item';
            
            const card = document.createElement('div');
            card.className = 'wish-card';
            
            const starColors = {
                1: '#f5f5f5',
                2: '#4caf50',
                3: '#2196f3',
                4: '#9c27b0',
                5: '#ff9800',
                6: '#ffd700',
                7: '#ff0000'
            };
            
            let starsHTML = '';
            for (let i = 0; i < weapon.rarity; i++) {
                starsHTML += `<span class="star" style="color: ${starColors[weapon.rarity]}">★</span>`;
            }
            
            const front = document.createElement('div');
            front.className = `wish-card-front rarity-${weapon.rarity}`;
            front.innerHTML = `
                <img src="${weaponImages[weapon.type] || 'https://via.placeholder.com/150?text=未知武器'}" class="item-image">
                <div class="item-name">${weapon.name}</div>
                <div class="rarity-stars">${starsHTML}</div>
                <div>${weapon.type}</div>
            `;
            
            const back = document.createElement('div');
            back.className = `wish-card-back rarity-${weapon.rarity}`;
            back.innerHTML = `
                <div class="item-name">${weapon.name}</div>
                <div class="rarity-stars">${starsHTML}</div>
                <div>${weapon.type}</div>
                <div class="item-description">${weapon.description}</div>
            `;
            
            card.appendChild(front);
            card.appendChild(back);
            item.appendChild(card);
            
            card.addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            elements.results.appendChild(item);
            return weapon;
        }

        function wishAnimation(count, callback) {
            wishEffect.classList.add('active');
            elements.results.innerHTML = '';
            
            setTimeout(() => {
                wishEffect.classList.remove('active');
                setTimeout(() => {
                    const results = [];
                    for (let i = 0; i < count; i++) {
                        results.push(generateWeapon());
                    }
                    callback(results);
                }, 300);
            }, 3000);
        }

        function createParticles() {
            const particleBg = document.getElementById('particle-bg');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 5 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 5 + 5}s`;
                particleBg.appendChild(particle);
            }
        }

        function preloadImage(url) {
            const img = new Image();
            img.src = url;
            img.onload = () => {
                console.log('Image loaded successfully:', url);
            };
            img.onerror = () => {
                console.error('Failed to load image:', url);
            };
        }

        // RPG游戏逻辑
        let player = {
            level: 1,
            exp: 0,
            expToLevel: 50,
            hp: 100,
            maxHp: 100,
            attack: 10,
            defense: 0,
            gold: 0,
            inventory: [],
            inventoryCapacity: 10,
            equipment: {
                mainHand: null,
                offHand: null,
                accessory: null
            }
        };

        let monster = {
            hp: 0,
            attack: 0
        };

        let battleCount = 0;
        let isFighting = false;
        let autoFightInterval = null;

        const gameElements = {
            playerLevel: document.getElementById('player-level'),
            playerExp: document.getElementById('player-exp'),
            expToLevel: document.getElementById('exp-to-level'),
            playerHp: document.getElementById('player-hp'),
            playerMaxHp: document.getElementById('player-max-hp'),
            playerAttack: document.getElementById('player-attack'),
            playerDefense: document.getElementById('player-defense'),
            playerGold: document.getElementById('player-gold'),
            monsterHp: document.getElementById('monster-hp'),
            monsterAttack: document.getElementById('monster-attack'),
            battleCount: document.getElementById('battle-count'),
            battleLog: document.getElementById('battle-log'),
            fightButton: document.getElementById('fight-button'),
            gachaButton: document.getElementById('gacha-button'),
            healButton: document.getElementById('heal-button'),
            inventoryCount: document.getElementById('inventory-count'),
            inventoryList: document.getElementById('inventory-list'),
            mainHandSlot: document.getElementById('main-hand-slot'),
            offHandSlot: document.getElementById('off-hand-slot'),
            accessorySlot: document.getElementById('accessory-slot'),
            enhanceList: document.getElementById('enhance-list')
        };

        function updateGameUI() {
            gameElements.playerLevel.textContent = player.level;
            gameElements.playerExp.textContent = player.exp;
            gameElements.expToLevel.textContent = player.expToLevel;
            gameElements.playerHp.textContent = player.hp;
            gameElements.playerMaxHp.textContent = player.maxHp;
            gameElements.playerAttack.textContent = player.attack;
            gameElements.playerDefense.textContent = player.defense;
            gameElements.playerGold.textContent = player.gold;
            gameElements.monsterHp.textContent = monster.hp;
            gameElements.monsterAttack.textContent = monster.attack;
            gameElements.battleCount.textContent = battleCount;
            gameElements.inventoryCount.textContent = player.inventory.length;

            gameElements.gachaButton.disabled = player.gold < 100 || isFighting;
            gameElements.healButton.disabled = player.gold < 10 || player.hp >= player.maxHp || isFighting;
            gameElements.fightButton.disabled = isFighting;
            updateEquipmentUI();
            updateEnhanceUI(player, gameElements);
        }

        function log(message) {
            gameElements.battleLog.innerHTML += `<p>${message}</p>`;
            gameElements.battleLog.scrollTop = gameElements.battleLog.scrollHeight;
        }

        function updateEquipmentUI() {
            if (player.equipment.mainHand) {
                const weapon = player.equipment.mainHand;
                const enhanceText = weapon.enhanceLevel > 0 ? `+${weapon.enhanceLevel}` : '';
                gameElements.mainHandSlot.innerHTML = `
                    <div class="equipment-slot-info">
                        主手: 
                        <img src="${weaponImages[weapon.type]}" class="equipment-slot-icon">
                        ${weapon.name} ${enhanceText} (${weapon.type}, ${weapon.rarity}★)
                    </div>
                    <button class="action-button unequip-button" data-slot="mainHand">卸下</button>
                `;
            } else {
                gameElements.mainHandSlot.innerHTML = '<div class="equipment-slot-info">主手: 无装备</div>';
            }

            if (player.equipment.offHand) {
                const weapon = player.equipment.offHand;
                const enhanceText = weapon.enhanceLevel > 0 ? `+${weapon.enhanceLevel}` : '';
                gameElements.offHandSlot.innerHTML = `
                    <div class="equipment-slot-info">
                        副手: 
                        <img src="${weaponImages[weapon.type]}" class="equipment-slot-icon">
                        ${weapon.name} ${enhanceText} (${weapon.type}, ${weapon.rarity}★)
                    </div>
                    <button class="action-button unequip-button" data-slot="offHand">卸下</button>
                `;
            } else {
                gameElements.offHandSlot.innerHTML = '<div class="equipment-slot-info">副手: 无装备</div>';
            }

            if (player.equipment.accessory) {
                const weapon = player.equipment.accessory;
                const enhanceText = weapon.enhanceLevel > 0 ? `+${weapon.enhanceLevel}` : '';
                gameElements.accessorySlot.innerHTML = `
                    <div class="equipment-slot-info">
                        饰品: 
                        <img src="${weaponImages[weapon.type]}" class="equipment-slot-icon">
                        ${weapon.name} ${enhanceText} (${weapon.type}, ${weapon.rarity}★)
                    </div>
                    <button class="action-button unequip-button" data-slot="accessory">卸下</button>
                `;
            } else {
                gameElements.accessorySlot.innerHTML = '<div class="equipment-slot-info">饰品: 无装备</div>';
            }

            document.querySelectorAll('.unequip-button').forEach(button => {
                button.removeEventListener('click', handleUnequip); // 防止重复绑定
                button.addEventListener('click', handleUnequip);
            });
        }

        function handleUnequip(e) {
            const slot = e.target.getAttribute('data-slot');
            unequipWeapon(slot);
        }

        function addToInventory(weapon) {
            if (player.inventory.length >= player.inventoryCapacity) {
                log('背包已满！请出售或丢弃武器以腾出空间');
                displayWeapon(weapon);
                return;
            }

            player.inventory.push(weapon);
            log(`获得武器 "${weapon.name}" (${weapon.rarity}★)，已存入背包`);
            updateInventoryUI();
            updateEnhanceUI(player, gameElements);
            updateGameUI();
        }

        function updateInventoryUI() {
            gameElements.inventoryList.innerHTML = '';
            player.inventory.forEach((weapon, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                const canEquipMainHand = ['单手剑', '双手剑', '法杖', '弓', '魔法书', '匕首'].includes(weapon.type);
                const canEquipOffHand = ['盾牌', '匕首'].includes(weapon.type);
                const enhanceText = weapon.enhanceLevel > 0 ? `+${weapon.enhanceLevel}` : '';
                itemDiv.innerHTML = `
                    <div class="inventory-item-info">${weapon.name} ${enhanceText} (${weapon.type}, ${weapon.rarity}★)</div>
                    <div class="inventory-item-actions">
                        ${canEquipMainHand ? `<button class="action-button equip-main-hand-button" data-index="${index}" data-slot="mainHand">装备主手</button>` : ''}
                        ${canEquipOffHand ? `<button class="action-button equip-off-hand-button" data-index="${index}" data-slot="offHand">装备副手</button>` : ''}
                        <button class="action-button equip-accessory-button" data-index="${index}" data-slot="accessory">装备饰品</button>
                        <button class="action-button sell-button" data-index="${index}">出售 (${weapon.rarity * 20}金币)</button>
                    </div>
                `;
                gameElements.inventoryList.appendChild(itemDiv);
            });

            document.querySelectorAll('.equip-main-hand-button, .equip-off-hand-button, .equip-accessory-button').forEach(button => {
                button.removeEventListener('click', handleEquip); // 防止重复绑定
                button.addEventListener('click', handleEquip);
            });

            document.querySelectorAll('.sell-button').forEach(button => {
                button.removeEventListener('click', handleSell); // 防止重复绑定
                button.addEventListener('click', handleSell);
            });
        }

        function handleEquip(e) {
            const index = parseInt(e.target.getAttribute('data-index'));
            const slot = e.target.getAttribute('data-slot');
            equipWeapon(index, slot);
        }

        function handleSell(e) {
            const index = parseInt(e.target.getAttribute('data-index'));
            sellWeapon(index);
        }

        function updateEquippedWeaponStats(weapon) {
            const canEquipMainHand = ['单手剑', '双手剑', '法杖', '弓', '魔法书', '匕首'].includes(weapon.type);
            const canEquipOffHand = ['盾牌', '匕首'].includes(weapon.type);

            let slot = null;
            if (player.equipment.mainHand === weapon) slot = 'mainHand';
            else if (player.equipment.offHand === weapon) slot = 'offHand';
            else if (player.equipment.accessory === weapon) slot = 'accessory';

            if (!slot) return;

            let oldAttackBonus = 0, oldDefenseBonus = 0, oldHpBonus = 0;
            if (slot === 'mainHand') {
                oldAttackBonus = weapon.rarity * 10 + (weapon.enhanceLevel > 0 ? weapon.rarity * (weapon.enhanceLevel - 1) * 2 : 0);
                player.attack -= oldAttackBonus;
            } else if (slot === 'offHand') {
                oldDefenseBonus = weapon.rarity * 5 + (weapon.enhanceLevel > 0 ? weapon.rarity * (weapon.enhanceLevel - 1) : 0);
                player.defense -= oldDefenseBonus;
            } else if (slot === 'accessory') {
                oldHpBonus = weapon.rarity * 20 + (weapon.enhanceLevel > 0 ? weapon.rarity * (weapon.enhanceLevel - 1) * 5 : 0);
                player.maxHp -= oldHpBonus;
                player.hp = Math.min(player.hp, player.maxHp);
            }

            if (slot === 'mainHand') {
                const attackBonus = weapon.rarity * 10 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel * 2 : 0);
                player.attack += attackBonus;
                gameElements.playerAttack.classList.add('blink');
            } else if (slot === 'offHand') {
                const defenseBonus = weapon.rarity * 5 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel : 0);
                player.defense += defenseBonus;
                gameElements.playerDefense.classList.add('blink');
            } else if (slot === 'accessory') {
                const hpBonus = weapon.rarity * 20 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel * 5 : 0);
                player.maxHp += hpBonus;
                player.hp = Math.min(player.hp, player.maxHp);
                gameElements.playerMaxHp.classList.add('blink');
                gameElements.playerHp.classList.add('blink');
            }

            player.attack = Math.max(0, player.attack);
            player.defense = Math.max(0, player.defense);
            player.maxHp = Math.max(1, player.maxHp);
            player.hp = Math.max(0, player.hp);
        }

        function equipWeapon(index, slot) {
            const weapon = player.inventory[index];
            if (!weapon) return;

            if (player.equipment[slot]) {
                const oldWeapon = player.equipment[slot];
                if (player.inventory.length >= player.inventoryCapacity) {
                    const confirmDiscard = confirm(`背包已满，是否丢弃当前${slot === 'mainHand' ? '主手' : slot === 'offHand' ? '副手' : '饰品'}装备 "${oldWeapon.name}" 以装备新物品？`);
                    if (!confirmDiscard) {
                        log(`取消装备 "${weapon.name}"，背包已满且未选择丢弃当前装备`);
                        return;
                    }
                    log(`背包已满，丢弃了${slot === 'mainHand' ? '主手' : slot === 'offHand' ? '副手' : '饰品'}装备 "${oldWeapon.name}"`);
                } else {
                    player.inventory.push(oldWeapon);
                    log(`${slot === 'mainHand' ? '主手' : slot === 'offHand' ? '副手' : '饰品'}装备 "${oldWeapon.name}" 已返回背包`);
                }

                if (slot === 'mainHand') {
                    const attackBonus = oldWeapon.rarity * 10 + (oldWeapon.enhanceLevel > 0 ? oldWeapon.rarity * oldWeapon.enhanceLevel * 2 : 0);
                    player.attack -= attackBonus;
                    log(`卸下主手装备 "${oldWeapon.name}"，攻击力减少 ${attackBonus}`);
                    gameElements.playerAttack.classList.add('blink');
                } else if (slot === 'offHand') {
                    const defenseBonus = oldWeapon.rarity * 5 + (oldWeapon.enhanceLevel > 0 ? oldWeapon.rarity * oldWeapon.enhanceLevel : 0);
                    player.defense -= defenseBonus;
                    log(`卸下副手装备 "${oldWeapon.name}"，防御力减少 ${defenseBonus}`);
                    gameElements.playerDefense.classList.add('blink');
                } else if (slot === 'accessory') {
                    const hpBonus = oldWeapon.rarity * 20 + (oldWeapon.enhanceLevel > 0 ? oldWeapon.rarity * oldWeapon.enhanceLevel * 5 : 0);
                    player.maxHp -= hpBonus;
                    player.hp = Math.min(player.hp, player.maxHp);
                    log(`卸下饰品 "${oldWeapon.name}"，生命值上限减少 ${hpBonus}`);
                    gameElements.playerMaxHp.classList.add('blink');
                    gameElements.playerHp.classList.add('blink');
                }
            }

            player.equipment[slot] = weapon;
            if (slot === 'mainHand') {
                const attackBonus = weapon.rarity * 10 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel * 2 : 0);
                player.attack += attackBonus;
                log(`装备主手 "${weapon.name}" (${weapon.rarity}★)，攻击力提升 ${attackBonus}，当前攻击力: ${player.attack}`);
                gameElements.playerAttack.classList.add('blink');
                gameElements.mainHandSlot.classList.add('glow');
            } else if (slot === 'offHand') {
                const defenseBonus = weapon.rarity * 5 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel : 0);
                player.defense += defenseBonus;
                log(`装备副手 "${weapon.name}" (${weapon.rarity}★)，防御力提升 ${defenseBonus}，当前防御力: ${player.defense}`);
                gameElements.playerDefense.classList.add('blink');
                gameElements.offHandSlot.classList.add('glow');
            } else if (slot === 'accessory') {
                const hpBonus = weapon.rarity * 20 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel * 5 : 0);
                player.maxHp += hpBonus;
                player.hp += hpBonus;
                log(`装备饰品 "${weapon.name}" (${weapon.rarity}★)，生命值上限提升 ${hpBonus}，当前生命值: ${player.hp}/${player.maxHp}`);
                gameElements.playerMaxHp.classList.add('blink');
                gameElements.playerHp.classList.add('blink');
                gameElements.accessorySlot.classList.add('glow');
            }

            player.inventory.splice(index, 1);
            updateInventoryUI();
            updateEnhanceUI(player, gameElements);
            updateGameUI();
        }

        function unequipWeapon(slot) {
            const weapon = player.equipment[slot];
            if (!weapon) return;

            if (player.inventory.length >= player.inventoryCapacity) {
                log('背包已满！请出售或丢弃武器以腾出空间');
                return;
            }

            player.inventory.push(weapon);
            log(`${slot === 'mainHand' ? '主手' : slot === 'offHand' ? '副手' : '饰品'}装备 "${weapon.name}" 已卸下并存入背包`);

            if (slot === 'mainHand') {
                const attackBonus = weapon.rarity * 10 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel * 2 : 0);
                player.attack -= attackBonus;
                log(`卸下主手装备 "${weapon.name}"，攻击力减少 ${attackBonus}，当前攻击力: ${player.attack}`);
                gameElements.playerAttack.classList.add('blink');
            } else if (slot === 'offHand') {
                const defenseBonus = weapon.rarity * 5 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel : 0);
                player.defense -= defenseBonus;
                log(`卸下副手装备 "${weapon.name}"，防御力减少 ${defenseBonus}，当前防御力: ${player.defense}`);
                gameElements.playerDefense.classList.add('blink');
            } else if (slot === 'accessory') {
                const hpBonus = weapon.rarity * 20 + (weapon.enhanceLevel > 0 ? weapon.rarity * weapon.enhanceLevel * 5 : 0);
                player.maxHp -= hpBonus;
                player.hp = Math.min(player.hp, player.maxHp);
                log(`卸下饰品 "${weapon.name}"，生命值上限减少 ${hpBonus}，当前生命值: ${player.hp}/${player.maxHp}`);
                gameElements.playerMaxHp.classList.add('blink');
                gameElements.playerHp.classList.add('blink');
            }

            player.equipment[slot] = null;
            updateInventoryUI();
            updateEnhanceUI(player, gameElements);
            updateGameUI();
        }

        function sellWeapon(index) {
            const weapon = player.inventory[index];
            if (!weapon) return;

            const gold = weapon.rarity * 20;
            player.gold += gold;
            log(`出售 "${weapon.name}" (${weapon.rarity}★)，获得 ${gold} 金币`);
            player.inventory.splice(index, 1);
            updateInventoryUI();
            updateEnhanceUI(player, gameElements);
            updateGameUI();
        }

        function levelUp() {
            while (player.exp >= player.expToLevel) {
                player.level++;
                player.exp -= player.expToLevel;
                player.expToLevel = Math.floor(player.expToLevel * 1.5);
                player.maxHp += 20;
                player.hp = player.maxHp;
                player.attack += 5;
                player.defense += 2;
                log(`恭喜升级！当前等级: ${player.level}，生命值上限+20，攻击力+5，防御力+2`);
                gameElements.playerLevel.classList.add('blink');
                gameElements.playerMaxHp.classList.add('blink');
                gameElements.playerHp.classList.add('blink');
                gameElements.playerAttack.classList.add('blink');
                gameElements.playerDefense.classList.add('blink');
            }
            updateGameUI();
        }

        function generateMonster() {
            const baseHp = 25 + (battleCount * 10);
            const baseAttack = 7 + Math.floor(battleCount / 2);
            const levelMultiplier = 1 + (player.level - 1) * 0.1;

            monster.hp = Math.floor(baseHp * levelMultiplier);
            monster.attack = Math.floor(baseAttack * levelMultiplier);
            log(`第 ${battleCount} 次战斗开始！遇到怪物（生命值: ${monster.hp}, 攻击力: ${monster.attack}）`);
            updateGameUI();
        }

        function fightRound() {
            if (isFighting) {
                console.log('战斗进行中，请等待！');
                return;
            }

            isFighting = true;
            gameElements.fightButton.disabled = true;
            console.log('战斗开始，按钮已禁用');

            if (monster.hp <= 0) {
                battleCount++;
                generateMonster();
            }

            // 自动战斗循环
            autoFightInterval = setInterval(() => {
                try {
                    // 玩家攻击怪物
                    let damageToMonster = player.attack;
                    monster.hp -= damageToMonster;
                    log(`玩家攻击怪物，造成 ${damageToMonster} 点伤害，怪物剩余生命值: ${monster.hp}`);

                    // 检查怪物是否被击败
                    if (monster.hp <= 0) {
                        const expGain = 10;
                        const goldGain = 33;
                        player.exp += expGain;
                        player.gold += goldGain;
                        log(`怪物被击败！获得 ${goldGain} 金币和 ${expGain} 经验值`);
                        levelUp();
                        monster.hp = 0;
                        updateGameUI();
                        clearInterval(autoFightInterval);
                        isFighting = false;
                        gameElements.fightButton.disabled = false;
                        console.log('战斗结束，按钮已启用');
                        return;
                    }

                    // 怪物攻击玩家
                    let damageToPlayer = Math.max(1, monster.attack - player.defense);
                    let damageReduction = player.defense;
                    player.hp -= damageToPlayer;
                    log(`怪物攻击玩家，造成 ${damageToPlayer} 点伤害（减免 ${damageReduction}），玩家剩余生命值: ${player.hp}`);

                    // 检查玩家是否死亡
                    if (player.hp <= 0) {
                        log('玩家被击败！游戏结束');
                        player.hp = 0;
                        gameElements.fightButton.disabled = true;
                        gameElements.gachaButton.disabled = true;
                        gameElements.healButton.disabled = true;
                        clearInterval(autoFightInterval);
                        isFighting = false;
                        updateGameUI();
                        alert('游戏结束！你被怪物击败了。刷新页面以重新开始。');
                        return;
                    }

                    updateGameUI();
                } catch (error) {
                    console.error('战斗中发生错误:', error);
                    log(`战斗中发生错误: ${error.message}`);
                    clearInterval(autoFightInterval);
                    isFighting = false;
                    gameElements.fightButton.disabled = false;
                }
            }, 1000); // 每秒进行一回合战斗
        }

        // 初始化函数
        function initializeGame() {
            preloadImage('https://static.wikia.nocookie.net/to-aru-majutsu-no-index/images/1/12/Pentagram-GreatGold.png');
            createParticles();
            updateStats();
            updateGameUI();
            updateEnhanceUI(player, gameElements);

            // 绑定主要按钮事件
            if (gameElements.fightButton) {
                gameElements.fightButton.removeEventListener('click', fightRound); // 防止重复绑定
                gameElements.fightButton.addEventListener('click', fightRound);
                console.log('战斗按钮事件已绑定');
            } else {
                console.error('无法找到 fight-button 元素');
            }

            if (gameElements.gachaButton) {
                gameElements.gachaButton.removeEventListener('click', handleGacha); // 防止重复绑定
                gameElements.gachaButton.addEventListener('click', handleGacha);
            }

            if (gameElements.healButton) {
                gameElements.healButton.removeEventListener('click', handleHeal); // 防止重复绑定
                gameElements.healButton.addEventListener('click', handleHeal);
            }

            if (elements.btnSingle) {
                elements.btnSingle.removeEventListener('click', handleSingleWish); // 防止重复绑定
                elements.btnSingle.addEventListener('click', handleSingleWish);
            }

            if (elements.btnMulti) {
                elements.btnMulti.removeEventListener('click', handleMultiWish); // 防止重复绑定
                elements.btnMulti.addEventListener('click', handleMultiWish);
            }

            // 绑定强化按钮事件
            document.querySelectorAll('.enhance-button').forEach(button => {
                button.removeEventListener('click', handleEnhance); // 防止重复绑定
                button.addEventListener('click', handleEnhance);
            });
        }

        function handleGacha() {
            if (player.gold < 100) {
                log('金币不足！抽卡需要 100 金币');
                return;
            }
            player.gold -= 100;
            wishAnimation(1, (results) => {
                results.forEach((weapon) => {
                    const newWeapon = displayWeapon(weapon);
                    addToInventory(newWeapon);
                });
                updateStats();
                updateGameUI();
            });
        }

        function handleHeal() {
            if (player.gold < 10) {
                log('金币不足！回血需要 10 金币');
                return;
            }
            if (player.hp >= player.maxHp) {
                log('生命值已满，无需回血');
                return;
            }
            player.gold -= 10;
            player.hp = player.maxHp;
            log('已回满生命值！');
            gameElements.playerHp.classList.add('blink');
            updateGameUI();
        }

        function handleSingleWish() {
            wishAnimation(1, (results) => {
                results.forEach((weapon) => {
                    const newWeapon = displayWeapon(weapon);
                    addToInventory(newWeapon);
                });
                updateStats();
            });
        }

        function handleMultiWish() {
            wishAnimation(10, (results) => {
                results.forEach((weapon, i) => {
                    setTimeout(() => {
                        const newWeapon = displayWeapon(weapon);
                        addToInventory(newWeapon);
                    }, i * 150);
                });
                updateStats();
            });
        }

        function handleEnhance(e) {
            const source = e.target.getAttribute('data-source');
            if (source === 'inventory') {
                const index = parseInt(e.target.getAttribute('data-index'));
                const weapon = player.inventory[index];
                enhanceWeapon(weapon, 'inventory', index, player, gameElements, updateInventoryUI, () => updateEnhanceUI(player, gameElements), updateGameUI, updateEquippedWeaponStats, log);
            } else if (source === 'equipment') {
                const slot = e.target.getAttribute('data-slot');
                const weapon = player.equipment[slot];
                enhanceWeapon(weapon, 'equipment', slot, player, gameElements, updateInventoryUI, () => updateEnhanceUI(player, gameElements), updateGameUI, updateEquippedWeaponStats, log);
            }
        }

        // 确保 DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>